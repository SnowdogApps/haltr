<%=
  cols = {
    :invoice => {
      l(:field_number)           => :number,
      l(:field_date)             => :date,
      l(:field_state)            => :state,
      l(:field_extra_info)       => :extra_info,
      l(:field_terms)            => :terms_description,
      l(:field_discount_text)    => :discount_text,
      l(:field_discount_percent) => :discount_percent,
      l(:field_due_date)         => :due_date,
      l(:field_import)           => :import,
      l(:field_ponumber)         => :ponumber,
      l(:field_currency)         => :currency,
      l(:field_payment_method)   => :payment_method,
      l(:label_total)            => :total,
      l(:field_accounting_cost)  => :accounting_cost,
      l(:field_posicio_comanda)  => :posicio_comanda,
      l(:field_num_albara)       => :num_albara,
      l(:field_charge_amount)    => :charge_amount,
      l(:field_charge_reason)    => :charge_reason,
      l(:unitat_tramitadora)     => :codi_unitat_tramitadora,
      l(:organ_gestor)           => :organ_gestor,
      l(:oficina_contable)       => :oficina_contable,
      l(:field_file_reference)   => :file_reference,
    },
    :client => {
      l(:field_name)    => :name,
      l(:field_taxcode) => :taxcode,
      l(:field_address) => :address,
    }
  }
  CSV.generate(
    :headers => (cols[:invoice].keys+cols[:client].keys),
    :write_headers=>true
  ) do |csv|
    @invoices.each do |invoice|
      csv << cols.collect {|o,methods|
        methods.values.collect {|m|
          case o.to_s
          when 'invoice'
            case m
            when :payment_method
              @invoice = invoice
              payment_method_info.gsub(/<br \/>/,'') rescue ""
            when :state
              l("state_#{invoice.state}")
            when :organ_gestor
              invoice.dir3.unitat_tramitadora_id rescue ""
            when :oficina_contable
              invoice.dir3.oficina_contable_id rescue ""
            else
              invoice.send(m)
            end
          when 'client'
            invoice.client.send(m)
          end
        }
      }.flatten
    end
  end.html_safe
%>
